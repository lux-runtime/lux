--!nocheck

--[=[
    @class RunService

    Provides signals for game loop timing and frame management.

    RunService is essential for creating smooth animations, physics simulations,
    and any time-based logic in your application.

    ### Signals

    | Signal | Description |
    |--------|-------------|
    | `Heartbeat` | Fires every frame with delta time |
    | `PreRender` | Fires before rendering |
    | `PostRender` | Fires after rendering |

    ### Functions

    | Function | Description |
    |----------|-------------|
    | `GetDeltaTime()` | Time since last frame |
    | `GetFPS()` | Current frames per second |
    | `GetFrame()` | Current frame number |
    | `IsRunning()` | Whether loop is active |
    | `Tick()` | Manually advance one frame |

    ### Example usage

    ```lua
    local RunService = require("@lux/runservice")

    -- Basic game loop
    RunService.Heartbeat:Connect(function(deltaTime)
        -- Update game logic
        player.x = player.x + player.velocity.x * deltaTime
        player.y = player.y + player.velocity.y * deltaTime
    end)

    -- FPS counter
    local frameCount = 0
    local elapsed = 0

    RunService.Heartbeat:Connect(function(dt)
        frameCount = frameCount + 1
        elapsed = elapsed + dt
        
        if elapsed >= 1.0 then
            print("FPS:", frameCount)
            frameCount = 0
            elapsed = 0
        end
    end)

    -- Smooth animation
    local angle = 0
    RunService.PreRender:Connect(function(dt)
        angle = angle + dt * math.pi -- Rotate 180Â° per second
        sprite.rotation = angle
    end)
    ```
]=]

-- ============================================================================
-- Types
-- ============================================================================

--[=[
    @interface Connection
    @within RunService

    Represents a connection to a RunService signal.
    
    ### Example
    ```lua
    local conn = RunService.Heartbeat:Connect(function(dt)
        print("Frame:", dt)
    end)
    
    -- Later...
    conn:Disconnect()
    ```
]=]
type Connection = {
	Connected: boolean,
	Disconnect: (self: Connection) -> (),
}

--[=[
    @interface Signal
    @within RunService

    A signal that fires during the game loop with delta time.
]=]
type Signal<T...> = {
	Connect: (self: Signal<T...>, callback: (T...) -> ()) -> Connection,
	Wait: (self: Signal<T...>) -> T...,
}

-- ============================================================================
-- Module
-- ============================================================================

local RunService = {}

--[=[
    @within RunService
    @prop Heartbeat Signal<number>

    Fires every frame with the delta time (time since last frame in seconds).

    This is the primary signal for game logic updates. It fires after input
    processing and before rendering.

    ### Example
    ```lua
    -- Smooth movement (frame-rate independent)
    local speed = 200 -- pixels per second
    
    RunService.Heartbeat:Connect(function(dt)
        local dx = 0
        if isKeyDown("D") then dx = 1 end
        if isKeyDown("A") then dx = -1 end
        
        player.x = player.x + dx * speed * dt
    end)
    
    -- Physics update
    local gravity = 980 -- pixels per second squared
    
    RunService.Heartbeat:Connect(function(dt)
        player.velocityY = player.velocityY + gravity * dt
        player.y = player.y + player.velocityY * dt
        
        -- Ground collision
        if player.y > groundY then
            player.y = groundY
            player.velocityY = 0
        end
    end)
    
    -- Timer
    local timer = 10
    RunService.Heartbeat:Connect(function(dt)
        timer = timer - dt
        if timer <= 0 then
            print("Time's up!")
            timer = 10
        end
    end)
    ```
]=]
RunService.Heartbeat = {} :: Signal<number>

--[=[
    @within RunService
    @prop PreRender Signal<number>

    Fires every frame before rendering begins.

    Use this for camera updates, UI positioning, or any visual adjustments
    that should happen right before the frame is drawn.

    ### Example
    ```lua
    -- Camera follow with smoothing
    RunService.PreRender:Connect(function(dt)
        local targetX = player.x - screenWidth / 2
        local targetY = player.y - screenHeight / 2
        
        -- Smooth interpolation
        local smoothing = 1 - math.pow(0.1, dt)
        camera.x = camera.x + (targetX - camera.x) * smoothing
        camera.y = camera.y + (targetY - camera.y) * smoothing
    end)
    
    -- UI element that follows an entity
    RunService.PreRender:Connect(function(dt)
        local screenPos = worldToScreen(enemy.x, enemy.y)
        healthBar.x = screenPos.x - healthBar.width / 2
        healthBar.y = screenPos.y - 50
    end)
    
    -- Smooth rotation animation
    local rotation = 0
    RunService.PreRender:Connect(function(dt)
        rotation = rotation + dt * 2 * math.pi -- Full rotation per second
        spinner.rotation = rotation
    end)
    ```
]=]
RunService.PreRender = {} :: Signal<number>

--[=[
    @within RunService
    @prop PostRender Signal<number>

    Fires every frame after rendering completes.

    Use this for cleanup, statistics gathering, or operations that should
    happen after the frame is displayed.

    ### Example
    ```lua
    -- Performance monitoring
    local frameTime = 0
    local maxFrameTime = 0
    
    RunService.PostRender:Connect(function(dt)
        frameTime = dt
        maxFrameTime = math.max(maxFrameTime, dt)
    end)
    
    -- Debug overlay update
    RunService.PostRender:Connect(function(dt)
        debugText.text = string.format(
            "FPS: %.1f | Frame: %.2fms | Max: %.2fms",
            1 / dt,
            dt * 1000,
            maxFrameTime * 1000
        )
    end)
    
    -- Screenshot/recording (after render complete)
    local recording = false
    local frames = {}
    
    RunService.PostRender:Connect(function(dt)
        if recording then
            table.insert(frames, captureScreen())
        end
    end)
    ```
]=]
RunService.PostRender = {} :: Signal<number>

--[=[
    @within RunService
    @tag must_use

    Returns the time elapsed since the last frame in seconds.

    @return number -- Delta time in seconds
    
    ### Example
    ```lua
    local dt = RunService:GetDeltaTime()
    print("Last frame took:", dt * 1000, "ms")
    
    -- Use outside of Heartbeat callback
    local function movePlayer(direction)
        local dt = RunService:GetDeltaTime()
        player.x = player.x + direction * speed * dt
    end
    ```
]=]
function RunService.GetDeltaTime(): number
	return 0
end

--[=[
    @within RunService
    @tag must_use

    Returns the current frames per second.

    @return number -- Current FPS (smoothed average)
    
    ### Example
    ```lua
    local fps = RunService:GetFPS()
    
    if fps < 30 then
        print("Warning: Low FPS!")
        -- Reduce quality settings
        setQualityLevel("low")
    elseif fps > 55 then
        -- Can increase quality
        setQualityLevel("high")
    end
    
    -- Display FPS
    fpsLabel.text = string.format("FPS: %.0f", fps)
    ```
]=]
function RunService.GetFPS(): number
	return 0
end

--[=[
    @within RunService
    @tag must_use

    Returns the current frame number since the application started.

    @return number -- Current frame count (starts at 0)
    
    ### Example
    ```lua
    local frame = RunService:GetFrame()
    
    -- Do something every 60 frames
    if frame % 60 == 0 then
        print("One second passed (at 60 FPS)")
        saveCheckpoint()
    end
    
    -- Flashing effect (visible every other frame)
    if frame % 2 == 0 then
        damageIndicator.visible = true
    else
        damageIndicator.visible = false
    end
    
    -- Staggered updates for many entities
    for i, entity in entities do
        if (frame + i) % 10 == 0 then
            entity:updateAI()
        end
    end
    ```
]=]
function RunService.GetFrame(): number
	return 0
end

--[=[
    @within RunService
    @tag must_use

    Returns whether the run loop is currently active.

    @return boolean -- True if the game loop is running
    
    ### Example
    ```lua
    if RunService:IsRunning() then
        print("Game loop is active")
    else
        print("Game loop has stopped")
    end
    
    -- Pause check
    while RunService:IsRunning() do
        -- Wait for game to resume
        task.wait(0.1)
    end
    ```
]=]
function RunService.IsRunning(): boolean
	return true
end

--[=[
    @within RunService

    Manually advances one frame (for testing or custom loops).

    This is typically not needed unless you're implementing a custom game loop
    or writing tests that need precise control over frame advancement.
    
    ### Example
    ```lua
    -- Custom fixed-timestep game loop
    local accumulator = 0
    local fixedDt = 1/60
    
    while running do
        local dt = getTime() - lastTime
        lastTime = getTime()
        accumulator = accumulator + dt
        
        while accumulator >= fixedDt do
            RunService:Tick() -- Advance one fixed frame
            accumulator = accumulator - fixedDt
        end
        
        render()
    end
    
    -- Unit testing
    local function testMovement()
        local player = Player.new()
        player.velocity = Vector2.new(100, 0)
        
        RunService:Tick() -- Simulate one frame
        
        assert(player.x > 0, "Player should have moved")
    end
    ```
]=]
function RunService.Tick() end

return RunService
